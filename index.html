<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Zusammenfügen - Kostenlos & Sicher</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF-Lib Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .drop-zone { transition: all 0.3s ease; }
        .drop-zone.dragover { border-color: #3b82f6; background-color: #eff6ff; transform: scale(1.01); }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-slate-200">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-file-pdf text-red-600 text-2xl"></i>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight">PDF Zusammenfügen</h1>
            </div>
            <div class="text-sm text-slate-500 hidden sm:block">
                <i class="fa-solid fa-shield-halved mr-1"></i> 100% Lokal & Sicher
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow container max-w-3xl mx-auto px-4 py-10">
        
        <div class="text-center mb-10">
            <h2 class="text-3xl md:text-4xl font-bold mb-4 text-slate-900">PDF-Dateien online zusammenfügen</h2>
            <p class="text-slate-600 text-lg">Wählen Sie mehrere PDF-Dateien aus und fügen Sie diese in Sekundenschnelle zu einem Dokument zusammen.</p>
        </div>

        <!-- Drop Zone -->
        <div id="dropZone" class="drop-zone bg-white border-2 border-dashed border-slate-300 rounded-2xl p-10 text-center cursor-pointer shadow-sm hover:shadow-md mb-8 relative group">
            <input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".pdf" multiple>
            <div class="pointer-events-none">
                <div class="bg-blue-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-blue-100 transition-colors">
                    <i class="fa-solid fa-cloud-arrow-up text-3xl text-blue-600"></i>
                </div>
                <h3 class="text-xl font-semibold text-slate-800 mb-2">Dateien hierher ziehen</h3>
                <p class="text-slate-500 mb-4">oder klicken, um Dateien auszuwählen</p>
                <span class="inline-block bg-blue-600 text-white px-6 py-2 rounded-lg font-medium text-sm shadow-md group-hover:bg-blue-700 transition-colors">
                    Dateien wählen
                </span>
            </div>
        </div>

        <!-- File List Area -->
        <div id="fileListContainer" class="hidden">
            <div class="flex justify-between items-end mb-4">
                <h3 class="text-lg font-semibold text-slate-800">Ausgewählte Dateien <span id="fileCount" class="bg-slate-200 text-slate-700 text-xs px-2 py-1 rounded-full ml-2">0</span></h3>
                <button onclick="clearAllFiles()" class="text-red-500 text-sm hover:text-red-700 hover:underline">Alle entfernen</button>
            </div>
            
            <ul id="fileList" class="space-y-3 mb-8">
                <!-- Files will be injected here via JS -->
            </ul>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8 pb-10">
                <button id="mergeBtn" onclick="mergePDFs()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-xl shadow-lg hover:shadow-blue-500/30 transition-all flex items-center justify-center gap-3 text-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="btnText">PDF Zusammenfügen</span>
                    <i id="btnIcon" class="fa-solid fa-arrow-right"></i>
                    <div id="btnLoader" class="loader hidden"></div>
                </button>
            </div>
        </div>

        <!-- Success Message / Download Area -->
        <div id="resultArea" class="hidden bg-green-50 border border-green-200 rounded-2xl p-8 text-center animate-fade-in mt-6">
            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-check text-3xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-green-800 mb-2">Erfolgreich zusammengefügt!</h3>
            <p class="text-green-700 mb-6">Ihre PDF-Datei ist fertig.</p>
            <a id="downloadLink" href="#" class="inline-flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all">
                <i class="fa-solid fa-download"></i>
                PDF Herunterladen
            </a>
            <button onclick="resetApp()" class="block w-full text-center mt-4 text-sm text-slate-500 hover:text-slate-700 underline">
                Weitere Dateien bearbeiten
            </button>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 py-8 mt-auto">
        <div class="container mx-auto px-4 text-center">
            <p class="text-slate-500 text-sm mb-2">
                <i class="fa-solid fa-lock text-green-600"></i> 
                Sicher & Privat: Die Verarbeitung erfolgt lokal in Ihrem Browser. Ihre Dateien verlassen niemals Ihr Gerät.
            </p>
            <p class="text-slate-400 text-xs">&copy; 2024 PDF Tools. All rights reserved.</p>
        </div>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        const { PDFDocument } = PDFLib;
        let filesArray = [];

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileList = document.getElementById('fileList');
        const fileCount = document.getElementById('fileCount');
        const mergeBtn = document.getElementById('mergeBtn');
        const btnText = document.getElementById('btnText');
        const btnIcon = document.getElementById('btnIcon');
        const btnLoader = document.getElementById('btnLoader');
        const resultArea = document.getElementById('resultArea');
        const downloadLink = document.getElementById('downloadLink');

        // Drag and Drop Events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() { dropZone.classList.add('dragover'); }
        function unhighlight() { dropZone.classList.remove('dragover'); }

        dropZone.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFiles, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles({ target: { files: files } });
        }

        function handleFiles(e) {
            const newFiles = [...e.target.files].filter(file => file.type === 'application/pdf');
            
            if(newFiles.length === 0 && e.target.files.length > 0) {
                alert("Bitte laden Sie nur PDF-Dateien hoch.");
                return;
            }

            filesArray = [...filesArray, ...newFiles];
            updateUI();
            // Reset input to allow selecting same files again if needed
            fileInput.value = ''; 
        }

        function removeFile(index) {
            filesArray.splice(index, 1);
            updateUI();
        }

        function moveUp(index) {
            if (index > 0) {
                [filesArray[index], filesArray[index - 1]] = [filesArray[index - 1], filesArray[index]];
                updateUI();
            }
        }

        function moveDown(index) {
            if (index < filesArray.length - 1) {
                [filesArray[index], filesArray[index + 1]] = [filesArray[index + 1], filesArray[index]];
                updateUI();
            }
        }

        function clearAllFiles() {
            filesArray = [];
            updateUI();
            resultArea.classList.add('hidden');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateUI() {
            fileList.innerHTML = '';
            fileCount.textContent = filesArray.length;

            if (filesArray.length > 0) {
                fileListContainer.classList.remove('hidden');
                mergeBtn.disabled = false;
            } else {
                fileListContainer.classList.add('hidden');
            }

            filesArray.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = "bg-white border border-slate-200 rounded-lg p-3 flex items-center justify-between shadow-sm transition-all hover:shadow-md";
                
                li.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="bg-red-100 text-red-600 w-8 h-8 rounded flex items-center justify-center flex-shrink-0">
                            <span class="text-xs font-bold">PDF</span>
                        </div>
                        <div class="min-w-0">
                            <p class="font-medium text-slate-700 truncate text-sm" title="${file.name}">${file.name}</p>
                            <p class="text-xs text-slate-400">${formatFileSize(file.size)}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="moveUp(${index})" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors ${index === 0 ? 'invisible' : ''}" title="Nach oben">
                            <i class="fa-solid fa-chevron-up"></i>
                        </button>
                        <button onclick="moveDown(${index})" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors ${index === filesArray.length - 1 ? 'invisible' : ''}" title="Nach unten">
                            <i class="fa-solid fa-chevron-down"></i>
                        </button>
                        <button onclick="removeFile(${index})" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors ml-1" title="Entfernen">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
                fileList.appendChild(li);
            });
        }

        async function mergePDFs() {
            if (filesArray.length < 1) return;

            // UI Loading State
            mergeBtn.disabled = true;
            btnText.textContent = "Verarbeitung...";
            btnIcon.classList.add('hidden');
            btnLoader.classList.remove('hidden');

            try {
                const mergedPdf = await PDFDocument.create();
                
                // Iterate through files
                for (const file of filesArray) {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await PDFDocument.load(arrayBuffer);
                    const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                    copiedPages.forEach((page) => mergedPdf.addPage(page));
                }

                // Save the PDF
                const pdfBytes = await mergedPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);

                // Setup Download
                downloadLink.href = url;
                downloadLink.download = `merged_document_${new Date().getTime()}.pdf`;

                // Show Success UI
                fileListContainer.classList.add('hidden');
                resultArea.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                alert("Ein Fehler ist aufgetreten. Bitte stellen Sie sicher, dass die PDF-Dateien nicht beschädigt sind.");
            } finally {
                // Reset Button State
                mergeBtn.disabled = false;
                btnText.textContent = "PDF Zusammenfügen";
                btnIcon.classList.remove('hidden');
                btnLoader.classList.add('hidden');
            }
        }

        function resetApp() {
            clearAllFiles();
            resultArea.classList.add('hidden');
            window.scrollTo(0,0);
        }
    </script>
</body>
</html>
